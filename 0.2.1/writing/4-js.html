<script>
    'use strict';

    class motiveHandler {
        constructor() {
            // 제시문 작성을 위해 작성해야 할 글감 수
            this.required = 3;

            this.createPrimaryBtn = document.getElementById('js--mh-create-primary');
            this.requestMotiveBtn = document.getElementById('js--mh-create-motive');

            this.updateCreatePrimaryBtn = this.updateCreatePrimaryBtn.bind(this)

            this.updateCreatePrimaryBtn();
        }

        updateCreatePrimaryBtn() {
            let written_motives = this.createPrimaryBtn.getAttribute('written');

            if (written_motives < this.required) {
                this.createPrimaryBtn.classList.add('inactive');
                this.createPrimaryBtn.innerHTML = `${written_motives}/${this.required}`;
            } else {
                this.createPrimaryBtn.classList.remove('inactive');
                this.createPrimaryBtn.innerHTML = '제시문 작성하기';
            }
        }
    }
    new motiveHandler();

    class editorManager {
        constructor() {
            this.types = document.getElementById('js--em-types'),
            this.maxTypes = 700;
            this.editor = document.getElementById('js--em-editor'),
            this.isOverTyped = false;

            this.addEventListeners = this.addEventListeners.bind(this);
            this.countLetters = this.countLetters.bind(this);

            this.addEventListeners();
        }

        addEventListeners() {
            this.editor.addEventListener('keyup', this.countLetters);
        }

        countLetters(evt) {
            let letters = evt.target.value.length;

            this.types.innerHTML = `${letters}/${this.maxTypes}`;

            if (!this.isOverTyped && letters > this.maxTypes) {
                this.types.style.color = 'rgb(211, 47, 47)';
                this.types.style.fontWeight = 'bold';
                this.isOverTyped = true;
            } else if (this.isOverTyped && letters <= this.maxTypes) {
                this.types.style.color = '';
                this.types.style.fontWeight = '';
                this.isOverTyped = false;
            }
        }
    }
    new editorManager();


    class dueCheck {
        constructor() {
            this.targetNodes = [];
            this.updateCycle = 1000;
            this.maxHoldDate = 3;

            this.renderTargets = this.renderTargets.bind(this);
            this.update = this.update.bind(this);
            this.removeCard = this.removeCard.bind(this);

            let that = this;
            window.setInterval(that.update, that.updateCycle);

            this.renderTargets();
        }

        // 새로 글 받아오면 renderTargets함수를 실행시켜줄 것.
        renderTargets() {
            this.targetNodes = document.querySelectorAll('.js--dc-card');
        }

        update() {
            let date = new Date();

            [].map.call(this.targetNodes, t => {
                let id = t.id,
                    timer = document.querySelector(`#${id} .js--dc-timer`);

                let r = {
                    d : parseInt(t.getAttribute('d')) - date.getDate(),
                    h : parseInt(t.getAttribute('h')) - date.getHours(),
                    m : parseInt(t.getAttribute('m')) - date.getMinutes(),
                    s : parseInt(t.getAttribute('s')) - date.getSeconds()
                };

                if (r.s < 0) {
                    r.s += 60;
                    r.m--;
                } if (r.m < 0) {
                    r.m += 60;
                    r.h--;
                } if (r.h < 0) {
                    r.h += 24;
                    r.d--;
                } if (r.d < 0) {
                    let endOfTheMonth = [
                            31, 28, 31, 30, 31, 30,
                            31, 31, 30, 31, 30, 31
                        ][date.getMonth()];

                    r.d = parseInt(t.getAttribute('d')) + endOfTheMonth - date.getDate();
                    
                    if (r.d < 0 || r.d > this.maxHoldDate) {
                        timer.innerHTML = 'DUE END';
                            
                        t.addEventListener('click', () => {
                            this.removeCard(id);
                        });
                        return;
                    }
                }

                let res = '';

                if (r.d == 0) {
                    if (r.h != 0)
                        res += ` ${r.h}H`;
                    if (r.m != 0)
                        res += ` ${r.m}M`;
                    if (r.s != 0)
                        res += ` ${r.s}S`;
                } else {
                    res += ` ${r.d}D`;
                    if (r.h != 0)
                        res += ` ${r.h}H`;
                    if (r.m != 0)
                        res += ` ${r.m}M`;
                }
                
                if (timer.innerHTML != res)
                    timer.innerHTML = res;
            });
        }

        removeCard(id) {
            let target = document.getElementById(id);

            target.style.maxHeight = `${target.getBoundingClientRect().height}px`;
            target.style.transition = 'transform .5s ease-in, opacity .5s linear, margin .35s ease, max-height .35s ease';

            target.style.opacity = '0';
            target.style.transform = 'translateX(100%)';

            setTimeout(() => {
                target.style.maxHeight = '0';
                target.style.margin = '0';
            }, 500);
        }
    }
    new dueCheck();
</script>